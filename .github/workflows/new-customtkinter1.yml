name: 手动触发打包(customtkinter + ffmpeg)

on:
  workflow_dispatch:          # 手动触发
  push:
    tags:
      - 'v*'                # tag 触发

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: 检出代码
      uses: actions/checkout@v4

    - name: 设置 Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: 安装打包工具和依赖
      run: |
        python -m pip install --upgrade pip
        pip install customtkinter tkinterdnd2 pyinstaller   # ← 这里改成新的依赖

    - name: 下载并提取 FFmpeg (最小化版)
      shell: pwsh
      run: |
        # 下载
        curl -L -o ffmpeg.zip https://www.gyan.dev/ffmpeg/builds/ffmpeg-release-essentials.zip
        # 解压
        Expand-Archive ffmpeg.zip -DestinationPath .
        # 自动定位文件夹并移动 exe
        $ffmpegDir = Get-ChildItem -Directory -Filter "ffmpeg-*" | Select-Object -First 1
        Move-Item "$($ffmpegDir.FullName)/bin/ffmpeg.exe" .
        Move-Item "$($ffmpegDir.FullName)/bin/ffprobe.exe" .

    - name: 下载 UPX 压缩引擎
      shell: pwsh
      run: |
        curl -L -o upx.zip https://github.com/upx/upx/releases/download/v4.2.2/upx-4.2.2-win64.zip
        Expand-Archive upx.zip -DestinationPath .
        $upxDir = Get-ChildItem -Directory -Filter "upx-*" | Select-Object -First 1
        Move-Item "$($upxDir.FullName)/upx.exe" .

    - name: 执行极致压缩打包
      shell: pwsh
      run: |
        pyinstaller --noconsole --onefile `
          --upx-dir=. `
          --add-binary "ffmpeg.exe;." `
          --add-binary "ffprobe.exe;." `
          --name "视频比例转换器" `
          main.py   # ← 如果你的主文件不是 main.py，这里改成你的文件名

    - name: 上传构建产物
      uses: actions/upload-artifact@v4
      with:
        name: Windows-EXE
        path: dist/视频比例转换器.exe   # ← 如果改了 --name，这里也要对应改

on:
  workflow_dispatch:          # 手动触发
  push:
    tags:
      - 'v*'                # tag 触发

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: 检出代码
      uses: actions/checkout@v4

    - name: 设置 Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: 安装打包工具和依赖
      run: |
        python -m pip install --upgrade pip
        pip install customtkinter tkinterdnd2 pyinstaller   # ← 这里改成新的依赖

    - name: 下载并提取 FFmpeg (最小化版)
      shell: pwsh
      run: |
        # 下载
        curl -L -o ffmpeg.zip https://www.gyan.dev/ffmpeg/builds/ffmpeg-release-essentials.zip
        # 解压
        Expand-Archive ffmpeg.zip -DestinationPath .
        # 自动定位文件夹并移动 exe
        $ffmpegDir = Get-ChildItem -Directory -Filter "ffmpeg-*" | Select-Object -First 1
        Move-Item "$($ffmpegDir.FullName)/bin/ffmpeg.exe" .
        Move-Item "$($ffmpegDir.FullName)/bin/ffprobe.exe" .

    - name: 下载 UPX 压缩引擎
      shell: pwsh
      run: |
        curl -L -o upx.zip https://github.com/upx/upx/releases/download/v4.2.2/upx-4.2.2-win64.zip
        Expand-Archive upx.zip -DestinationPath .
        $upxDir = Get-ChildItem -Directory -Filter "upx-*" | Select-Object -First 1
        Move-Item "$($upxDir.FullName)/upx.exe" .

    - name: 执行极致压缩打包
      shell: pwsh
      run: |
        pyinstaller --noconsole --onefile `
          --upx-dir=. `
          --add-binary "ffmpeg.exe;." `
          --add-binary "ffprobe.exe;." `
          --name "视频比例转换器" `
          main1.py   # ← 如果你的主文件不是 main.py，这里改成你的文件名

    - name: 上传构建产物
      uses: actions/upload-artifact@v4
      with:
        name: Windows-EXE
        path: dist/视频比例转换器.exe   # ← 如果改了 --name，这里也要对应改
