name: 2.手动触发极致压缩打包 (customtkinter + minimal ffmpeg)

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'

jobs:
  build:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4

    - uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: 安装依赖
      run: |
        python -m pip install --upgrade pip
        pip install customtkinter tkinterdnd2 pyinstaller

    - name: 下载 BtbN minimal FFmpeg
      shell: pwsh
      run: |
        # 下载 BtbN minimal 版（20–25MB）
        $url = "https://github.com/BtbN/FFmpeg-Builds/releases/latest/download/ffmpeg-master-latest-win64-gpl-minimal.zip"
        Invoke-WebRequest -Uri $url -OutFile ffmpeg.zip
        Expand-Archive ffmpeg.zip -DestinationPath .
        # 移动 exe（BtbN minimal 版直接在根目录 bin/ 下）
        Move-Item "bin\ffmpeg.exe" .
        Move-Item "bin\ffprobe.exe" .

    - name: 下载 UPX
      shell: pwsh
      run: |
        curl -L -o upx.zip https://github.com/upx/upx/releases/download/v4.2.4/upx-4.2.4-win64.zip
        Expand-Archive upx.zip -DestinationPath .
        $upxDir = Get-ChildItem -Directory -Filter "upx-*" | Select-Object -First 1
        Move-Item "$($upxDir.FullName)/upx.exe" .

    - name: PyInstaller 极致打包
      shell: pwsh
      run: |
        pyinstaller --noconsole --onefile `
          --clean --noconfirm `
          --upx-dir=. `
          --upx-exclude tkinter --upx-exclude tcl --upx-exclude tk `
          --add-binary "ffmpeg.exe;." `
          --add-binary "ffprobe.exe;." `
          --exclude-module matplotlib --exclude-module numpy --exclude-module pandas `
          --exclude-module scipy --exclude-module PIL `
          --name "PROVideoProcessor" `
          main1.py

    - uses: actions/upload-artifact@v4
      with:
        name: Windows-EXE
        path: dist/PROVideoProcessor.exe

    - name: 创建 Release
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v2
      with:
        files: dist/PROVideoProcessor.exe
        body: |
          customtkinter 版本，包含 minimal ffmpeg
          大小约 60-90MB，双击即用
