name: 手动触发打包 (onefile + onedir)

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: 检出代码
      uses: actions/checkout@v4

    - name: 设置 Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: 安装打包工具和依赖
      run: |
        python -m pip install --upgrade pip
        pip install customtkinter tkinterdnd2 pyinstaller

    - name: 下载并提取 FFmpeg (最小化版)
      shell: pwsh
      run: |
        curl -L -o ffmpeg.zip https://www.gyan.dev/ffmpeg/builds/ffmpeg-release-essentials.zip
        Expand-Archive ffmpeg.zip -DestinationPath .
        $ffmpegDir = Get-ChildItem -Directory -Filter "ffmpeg-*" | Select-Object -First 1
        Move-Item "$($ffmpegDir.FullName)/bin/ffmpeg.exe" .
        Move-Item "$($ffmpegDir.FullName)/bin/ffprobe.exe" .

    - name: 下载 UPX 压缩引擎
      shell: pwsh
      run: |
        curl -L -o upx.zip https://github.com/upx/upx/releases/download/v4.2.4/upx-4.2.4-win64.zip
        Expand-Archive upx.zip -DestinationPath .
        $upxDir = Get-ChildItem -Directory -Filter "upx-*" | Select-Object -First 1
        Move-Item "$($upxDir.FullName)/upx.exe" .

    - name: 打包 onefile 版本 (单 exe)
      shell: pwsh
      run: |
        pyinstaller --noconsole --onefile `
          --clean --noconfirm `
          --upx-dir=. `
          --add-binary "ffmpeg.exe;." `
          --add-binary "ffprobe.exe;." `
          --exclude-module matplotlib --exclude-module numpy --exclude-module pandas `
          --exclude-module scipy --exclude-module PIL `
          --name "PROVideoProcessor-OneFile" `
          main1.py

    - name: 打包 onedir 版本 (目录模式)
      shell: pwsh
      run: |
        pyinstaller --noconsole `
          --clean --noconfirm `
          --upx-dir=. `
          --add-binary "ffmpeg.exe;." `
          --add-binary "ffprobe.exe;." `
          --exclude-module matplotlib --exclude-module numpy --exclude-module pandas `
          --exclude-module scipy --exclude-module PIL `
          --name "PROVideoProcessor-Onedir" `
          main1.py

    - name: 压缩 onedir 文件夹为 zip
      shell: pwsh
      run: |
        # 先检查目录是否存在
        if (-Not (Test-Path dist/PROVideoProcessor-Onedir)) {
          Write-Error "onedir 目录未生成，打包可能失败"
          exit 1
        }
        # 压缩整个目录（包含 exe 和所有文件）
        Compress-Archive -Path dist/PROVideoProcessor-Onedir/* -DestinationPath dist/PROVideoProcessor-Onedir.zip -Force

    - name: 上传构建产物 (onefile)
      uses: actions/upload-artifact@v4
      with:
        name: PROVideoProcessor-OneFile
        path: dist/PROVideoProcessor-OneFile.exe

    - name: 上传构建产物 (onedir zip)
      uses: actions/upload-artifact@v4
      with:
        name: PROVideoProcessor-Onedir
        path: dist/PROVideoProcessor-Onedir.zip

    - name: 创建 Release 并上传文件
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v2
      with:
        files: |
          dist/PROVideoProcessor-OneFile.exe
          dist/PROVideoProcessor-Onedir.zip
        body: |
          本次 Release 提供两种版本：
          - PROVideoProcessor-OneFile.exe：单文件版（约 60MB），下载后直接双击运行
          - PROVideoProcessor-Onedir.zip：目录版（体积稍小，启动更快），解压后运行 exe
          已内置 ffmpeg，无需额外下载
