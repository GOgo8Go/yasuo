name: 极致压缩打包-CustomTkinter版

on:
  workflow_dispatch: # 支持手动点击运行

jobs:
  build:
    runs-on: windows-2019 # 使用 2019 保证最佳向下兼容性
    permissions:
      contents: write

    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 设置 Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: 安装基础依赖
        run: |
          python -m pip install --upgrade pip
          # 安装 CustomTkinter 和图片处理库 Pillow
          pip install customtkinter pillow pyinstaller

      - name: 准备 FFmpeg 核心组件
        shell: pwsh
        run: |
          # 下载 FFmpeg Release Essentials (约 100MB)
          curl -L -o ffmpeg.zip https://www.gyan.dev/ffmpeg/builds/ffmpeg-release-essentials.zip
          Expand-Archive ffmpeg.zip -DestinationPath .
          $f = Get-ChildItem -Directory -Filter "ffmpeg-*" | Select-Object -First 1
          # 提取 exe 到根目录供打包使用
          Move-Item "$($f.FullName)/bin/ffmpeg.exe" .
          Move-Item "$($f.FullName)/bin/ffprobe.exe" .

      - name: 下载并准备 UPX 压缩引擎
        shell: pwsh
        run: |
          curl -L -o upx.zip https://github.com/upx/upx/releases/download/v4.2.2/upx-4.2.2-win64.zip
          Expand-Archive upx.zip -DestinationPath .
          Move-Item "upx-4.2.2-win64/upx.exe" .

      - name: 执行单文件打包 (OneFile)
        shell: pwsh
        run: |
          # 核心策略说明：
          # --onefile: 封装成单个 EXE，方便分发
          # --upx-dir: 使用 UPX 对 DLL 和可执行文件进行二次压缩
          # --add-binary: 将 ffmpeg/ffprobe 封装进 EXE 内部
          # --add-data: 将图标文件打包进去，供代码中 sys._MEIPASS 调用
          pyinstaller --noconsole --onefile `
          --upx-dir=. `
          --icon="app_logo.ico" `
          --add-binary "ffmpeg.exe;." `
          --add-binary "ffprobe.exe;." `
          --add-data "app_logo.ico;." `
          --name "视频比例转换器" `
          main.py

      - name: 上传 Artifact (Actions面板可见)
        uses: actions/upload-artifact@v4
        with:
          name: VideoConverter_Standalone
          path: dist/视频比例转换器.exe

      - name: 创建 GitHub Release (仅在打标签时)
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: dist/视频比例转换器.exe
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
