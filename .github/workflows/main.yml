name: 手动触发极致压缩打包

on:
  workflow_dispatch: # 允许手动点击按钮触发
  push:
    tags: ['v*']     # 保留标签触发模式

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 设置 Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: 安装打包工具
        run: |
          python -m pip install --upgrade pip
          pip install PyQt6 pyinstaller

      - name: 下载精简版 FFmpeg (仅 50MB 左右)
        run: |
          curl -L -o ffmpeg.zip https://www.gyan.dev/ffmpeg/builds/ffmpeg-release-essentials.zip
          tar -xf ffmpeg.zip
          # 移动 exe 到根目录供打包使用
          child_dir=$(dir ffmpeg-*-essentials_build /b)
          move "ffmpeg-$child_dir/bin/ffmpeg.exe" .
          move "ffmpeg-$child_dir/bin/ffprobe.exe" .

      - name: 下载 UPX 压缩引擎
        run: |
          curl -L -o upx.zip https://github.com/upx/upx/releases/download/v4.2.2/upx-4.2.2-win64.zip
          tar -xf upx.zip
          move upx-4.2.2-win64/upx.exe .

      - name: 执行极致压缩打包
        run: |
          pyinstaller --noconsole --onefile `
          --upx-dir=. `
          --add-binary "ffmpeg.exe;." `
          --add-binary "ffprobe.exe;." `
          --name "视频比例转换器" `
          main.py

      - name: 上传构建产物
        uses: actions/upload-artifact@v4
        with:
          name: Windows-EXE
          path: dist/视频比例转换器.exe
